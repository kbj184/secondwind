name: Java CI/CD with Gradle and EC2

on:
  push:
    branches: [ "master" ] # ë°±ì—”ë“œ í”„ë¡œì íŠ¸ì˜ ë©”ì¸ ë¸Œëžœì¹˜ê°€ masterì¸ ê²ƒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 0. ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ (ì¶”ê°€ëœ ë¶€ë¶„ ðŸ“)
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 1. Gradle ë¹Œë“œ
    - name: Build with Gradle
      run: ./gradlew clean bootJar

    # 1.5. Firebase ì„œë¹„ìŠ¤ ê³„ì • íŒŒì¼ ìƒì„±
    - name: Create Firebase Service Account JSON
      run: |
        mkdir -p build/libs/resources
        echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}' > build/libs/resources/firebase-service-account.json

    # 2. ë¹Œë“œëœ JAR íŒŒì¼ì„ EC2ë¡œ ì „ì†¡ (SCP)
    - name: Copy JAR to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "build/libs/*.jar"
        target: "/home/ec2-user"
        strip_components: 2

    # 2.5. Firebase ì„œë¹„ìŠ¤ ê³„ì • íŒŒì¼ì„ EC2ë¡œ ì „ì†¡
    - name: Copy Firebase Service Account to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "build/libs/resources/firebase-service-account.json"
        target: "/home/ec2-user"
        strip_components: 3

    # 3. EC2ì—ì„œ ì„œë²„ ìž¬ì‹œìž‘ (SSH)
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # 1. ìƒˆë¡œìš´ JAR íŒŒì¼ êµì²´
          cd /home/ec2-user
          mv secondwind-0.0.1-SNAPSHOT.jar app.jar || mv *.jar app.jar || true
          
          # 2. í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (ì„œë¹„ìŠ¤ê°€ ì½ì„ ìˆ˜ ìžˆë„ë¡)
          echo "DB_URL=${{ secrets.DB_URL }}" > .env.prod
          echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env.prod
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env.prod
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env.prod
          echo "NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}" >> .env.prod
          echo "NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}" >> .env.prod
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env.prod
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env.prod
          echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> .env.prod
          echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> .env.prod
          echo "ALLOWED_ORIGINS=https://llrun.shop,https://www.llrun.shop,https://main.d2f7uw4hiwwlz7.amplifyapp.com" >> .env.prod
          
          # Firebase í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
          echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env.prod
          echo "FIREBASE_SERVICE_ACCOUNT_PATH=/home/ec2-user/firebase-service-account.json" >> .env.prod
          
          # 3. ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ (ê°€ìž¥ ê°€ë²¼ìš´ ìž‘ì—…)
          sudo systemctl restart running
